FROM ubuntu:22.04 as base

RUN apt-get update && apt-get install -y \
    apt-utils \
    libgdiplus \
    libc6-dev \
    libgtk2.0-dev \
    libtbb-dev \
    libatlas-base-dev \
    libvorbis-dev \
    libxvidcore-dev \
    libopencore-amrnb-dev \
    libopencore-amrwb-dev \
    x264 \
    v4l-utils \
    libwebp-dev \
    tesseract-ocr \
    libtesseract-dev \
    libleptonica-dev \
    libtiff-dev \
    libavcodec-dev \
    libavformat-dev \
    libswscale-dev \
    libxine2-dev \
    libv4l-dev
RUN apt-get clean && rm -rf /var/lib/apt/lists/*

# Install .NET SDK and runtime
RUN apt-get update && apt-get install -y wget && \
    wget https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb && \
    dpkg -i packages-microsoft-prod.deb && \
    apt-get update && apt-get install -y \
    apt-transport-https \
    dotnet-runtime-7.0 \
    dotnet-sdk-7.0 && \
    rm -rf /var/lib/apt/lists/*

FROM mcr.microsoft.com/dotnet/sdk:7.0 AS build
WORKDIR /src
COPY ["src/RealtimeCv.Worker/RealtimeCv.Worker.csproj", "src/RealtimeCv.Worker/"]
RUN dotnet restore "src/RealtimeCv.Worker/RealtimeCv.Worker.csproj"
COPY . .
WORKDIR "/src/src/RealtimeCv.Worker"
RUN dotnet build "RealtimeCv.Worker.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "RealtimeCv.Worker.csproj" -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "RealtimeCv.Worker.dll"]